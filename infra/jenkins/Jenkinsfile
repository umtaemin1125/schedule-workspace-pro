pipeline {
  agent any

  environment {
    PROJECT_DIR = ''
  }

  stages {
    stage('Init Workspace') {
      steps {
        script {
          env.PROJECT_DIR = sh(
            script: '''
              if [ -d backend ] && [ -d frontend ] && [ -d infra ]; then
                pwd
              elif [ -d schedule-workspace-pro/backend ] && [ -d schedule-workspace-pro/frontend ] && [ -d schedule-workspace-pro/infra ]; then
                echo "$(pwd)/schedule-workspace-pro"
              else
                echo "프로젝트 루트를 찾지 못했습니다." >&2
                exit 1
              fi
            ''',
            returnStdout: true
          ).trim()
          echo "PROJECT_DIR=${env.PROJECT_DIR}"
        }
      }
    }

    stage('Backend Test & Build') {
      steps {
        dir("${PROJECT_DIR}/backend") {
          sh './gradlew test bootJar --no-daemon'
        }
      }
    }

    stage('Frontend Test & Build') {
      steps {
        dir("${PROJECT_DIR}/frontend") {
          sh 'npm ci'
          sh 'npm run test'
          sh 'npm run build'
        }
      }
    }

    stage('Docker Build') {
      steps {
        dir("${PROJECT_DIR}/infra") {
          sh 'docker compose --profile full build'
        }
      }
    }

    stage('Smoke Test') {
      steps {
        dir("${PROJECT_DIR}/infra") {
          sh 'docker compose --profile dev up -d'
          sh 'bash ./scripts/smoke-test.sh'
          sh 'docker compose --profile dev down -v'
        }
      }
    }
  }
}
